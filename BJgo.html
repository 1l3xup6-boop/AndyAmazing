<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🂡 21 點最優策略（依剩餘牌組 · 手機版）</title>
<style>
  :root{
    --bg:#0b1020; --panel:#0f172a; --border:#22314f; --text:#e5e7eb; --muted:#9aa7bd;
    --accent:#22d3ee; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(900px 600px at 30% -20%, #18234a 0%, var(--bg) 60%) fixed;color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,"PingFang TC","Microsoft JhengHei",Arial}
  .wrap{max-width:780px;margin:0 auto;padding:12px}
  h1{margin:0 0 8px 0;font-size:20px;line-height:1.25}
  .sub{color:var(--muted);margin-bottom:10px;font-size:12px}
  .panel{background:rgba(15,23,42,.88);backdrop-filter:blur(8px);border:1px solid rgba(146,163,184,.25);border-radius:14px;padding:12px}
  label{font-size:12px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase}
  input,select,button{background:#0b1228;color:var(--text);border:1px solid rgba(146,163,184,.3);border-radius:12px;padding:10px 12px;font-size:16px}
  button{cursor:pointer}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .cards{display:flex;gap:8px;flex-wrap:wrap}
  .rank{padding:10px 12px;border:1px dashed rgba(146,163,184,.35);border-radius:12px;min-width:56px;min-height:44px;display:flex;flex-direction:column;align-items:center;justify-content:center;touch-action:manipulation}
  .rank:active{transform:scale(.98)}
  .count{font-size:12px;color:var(--muted)}
  .hand{display:flex;gap:8px;flex-wrap:wrap}
  .card{width:56px;height:80px;border-radius:12px;border:1px solid rgba(146,163,184,.35);display:grid;place-items:center;background:linear-gradient(180deg,#0f1a39,#0c1429);font-weight:800}
  .ghost{opacity:.6;font-style:italic}
  .actions{display:flex;gap:8px;flex-direction:column;margin-top:8px}
  .act{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.08);font-weight:700;display:flex;justify-content:space-between;align-items:center}
  .HIT{border-color:#6366f1}
  .STAND{border-color:#16a34a}
  .DOUBLE{border-color:#3b82f6}
  .SPLIT{border-color:#f59e0b}
  .SURRENDER{border-color:#ef4444}
  .ev{font-family:ui-monospace,Menlo,Consolas,monospace}
  .bar{height:10px;background:#0b1228;border:1px solid rgba(146,163,184,.25);border-radius:999px;overflow:hidden;width:100%}
  .fill{height:100%;background:linear-gradient(90deg,#06b6d4,#22d3ee)}
  .footer{color:var(--muted);text-align:center;margin:10px 0 4px 0;font-size:11px}
  .stack{display:grid;gap:12px}
  .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .kpis > div{background:#0b1228;border:1px solid rgba(146,163,184,.25);border-radius:12px;padding:10px;text-align:center}
  .sticky-bottom{position:sticky;bottom:8px;z-index:1}
  .btn-small{padding:8px 10px;font-size:14px;border-radius:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>🂡 21 點最優策略（依剩餘牌組 · 手機版）</h1>
  <div class="sub">點牌記錄 → 設定莊家/玩家 → 即時給出最優動作。點一下 +1，長按 -1（誤觸可按「撤銷已出牌」）。</div>

  <div class="panel stack">
    <div class="row">
      <div>
        <label>牌靴副數</label><br />
        <input type="number" id="decks" min="1" max="12" value="6" style="width:110px"/>
      </div>
      <div>
        <label>莊家軟17</label><br/>
        <select id="s17">
          <option value="H17">補牌 (H17)</option>
          <option value="S17" selected>停牌 (S17)</option>
        </select>
      </div>
      <div>
        <label>分牌後加倍</label><br/>
        <select id="das">
          <option value="DAS" selected>允許</option>
          <option value="NDAS">禁止</option>
        </select>
      </div>
      <div>
        <label>晚投降</label><br/>
        <select id="surrender">
          <option value="LS" selected>可</option>
          <option value="NS">不可</option>
        </select>
      </div>
      <div>
        <label>樣本數</label><br/>
        <input type="number" id="samples" min="500" max="30000" step="500" value="3000" style="width:120px"/>
      </div>
      <div class="row" style="margin-top:4px">
        <button class="btn-small" id="reset">重設</button>
        <button class="btn-small" id="undoSeen">撤銷已出牌</button>
      </div>
    </div>

    <div>
      <label>紀錄已出現的牌（點一下 +1；長按 -1）</label>
      <div id="seenBtns" class="cards" style="margin-top:6px"></div>
      <div class="kpis" id="shoeKpis" style="margin-top:6px">
        <div>
          <div class="count">剩餘牌數</div>
          <div id="leftCnt" style="font-weight:800;font-size:18px">—</div>
        </div>
        <div>
          <div class="count">高牌指示</div>
          <div id="hiCnt" style="font-weight:800;font-size:18px">—</div>
        </div>
      </div>
    </div>

    <div class="row" style="gap:16px">
      <div style="flex:1">
        <label>莊家明牌</label>
        <div id="dealerBtns" class="cards" style="margin-top:6px"></div>
        <div id="dealerView" class="hand" style="margin-top:6px"></div>
      </div>
      <div style="flex:1.4">
        <label>玩家手牌</label>
        <div id="playerBtns" class="cards" style="margin-top:6px"></div>
        <div class="row" style="margin-top:6px">
          <div id="playerView" class="hand"></div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn-small" id="undo">復原</button>
          <button class="btn-small" id="clear">清空</button>
        </div>
      </div>
    </div>

    <div class="sticky-bottom">
      <label>建議策略（依目前剩餘牌組估算 EV）</label>
      <div id="acts" class="actions"></div>
      <div id="winner" style="margin-top:6px;font-size:22px;font-weight:800">—</div>
      <div id="detail" class="ev" style="margin-top:4px;color:var(--muted)"></div>
    </div>
  </div>

  <div class="footer">手機版 · 單檔 HTML，可直接部署</div>
</div>

<script>
const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
function rankVal(r){ if(r==='A') return 11; if(r==='10'||r==='J'||r==='Q'||r==='K') return 10; return parseInt(r,10); }
function makeCardEl(r){ const d=document.createElement('div'); d.className='card'; d.textContent=r; return d; }

const seen = Object.fromEntries(RANKS.map(r=>[r,0]));
let seenHistory = [];
let dealer = null;
let player = [];

const els = {
  decks: document.getElementById('decks'),
  s17: document.getElementById('s17'),
  das: document.getElementById('das'),
  surrender: document.getElementById('surrender'),
  samples: document.getElementById('samples'),
  seenBtns: document.getElementById('seenBtns'),
  leftCnt: document.getElementById('leftCnt'),
  hiCnt: document.getElementById('hiCnt'),
  dealerBtns: document.getElementById('dealerBtns'),
  dealerView: document.getElementById('dealerView'),
  playerBtns: document.getElementById('playerBtns'),
  playerView: document.getElementById('playerView'),
  undo: document.getElementById('undo'),
  clear: document.getElementById('clear'),
  reset: document.getElementById('reset'),
  undoSeen: document.getElementById('undoSeen'),
  acts: document.getElementById('acts'),
  winner: document.getElementById('winner'),
  detail: document.getElementById('detail'),
};

function buildSeenButtons(){
  els.seenBtns.innerHTML='';
  RANKS.forEach(r=>{
    const wrap = document.createElement('div'); wrap.className = 'rank';
    const label = document.createElement('div'); label.textContent = r;
    const cnt = document.createElement('div'); cnt.className='count'; cnt.textContent = 'x'+seen[r];

    let pressTimer = null;
    let longPressed = false;
    const longMs = 600;
    function startPress(ev){ ev.preventDefault(); longPressed=false; pressTimer=setTimeout(()=>{ if(seen[r]>0){ seen[r]--; removeLastFromHistory(r); cnt.textContent='x'+seen[r]; render(); } longPressed=true; }, longMs);}
    function endPress(ev){ ev.preventDefault(); clearTimeout(pressTimer); if(!longPressed){ seen[r]++; seenHistory.push(r); cnt.textContent='x'+seen[r]; render(); } longPressed=false; }
    wrap.addEventListener('touchstart', startPress, {passive:false});
    wrap.addEventListener('touchend', endPress);
    wrap.addEventListener('mousedown', startPress);
    wrap.addEventListener('mouseup', endPress);
    wrap.addEventListener('mouseleave', ()=>{ clearTimeout(pressTimer); longPressed=false; });
    wrap.appendChild(label); wrap.appendChild(cnt);
    els.seenBtns.appendChild(wrap);
  });
}

function removeLastFromHistory(rank){
  for(let i=seenHistory.length-1;i>=0;i--){ if(seenHistory[i]===rank){ seenHistory.splice(i,1); return; } }
}

function buildPickers(){
  els.dealerBtns.innerHTML=''; els.playerBtns.innerHTML='';
  RANKS.forEach(r=>{
    const b1=document.createElement('button'); b1.className='rank'; b1.textContent=r; b1.onclick=()=>{ dealer=r; render(); }; els.dealerBtns.appendChild(b1);
    const b2=document.createElement('button'); b2.className='rank'; b2.textContent=r; b2.onclick=()=>{ player.push(r); render(); }; els.playerBtns.appendChild(b2);
  });
}

els.undoSeen.onclick = ()=>{
  if(seenHistory.length===0){ alert('沒有已出牌紀錄可撤銷'); return; }
  const last = seenHistory.pop();
  if(seen[last]>0) seen[last]--;
  buildSeenButtons();
  buildPickers();
  render();
};

function handTotal(cards){
  let sum=0, aces=0; for(const c of cards){ if(c==='A'){aces++; sum+=11;} else sum+=rankVal(c); }
  while(sum>21 && aces>0){ sum-=10; aces--; }
  const soft = cards.includes('A') && sum<=21 && (()=>{ let base=0,ac=0; for(const c of cards){ if(c==='A'){ac++; base+=1;} else base+=rankVal(c);} return base+10<=21; })();
  return {total:sum, soft};
}

function baseShoe(){ const d=parseInt(els.decks.value||6,10); return Object.fromEntries(RANKS.map(r=>[r,4*d])); }
function shoeAfterSeen(){ const shoe=baseShoe(); for(const r of RANKS){ shoe[r]-=seen[r]; } if(dealer) shoe[dealer]--; for(const r of player){ shoe[r]--; } for(const r of RANKS){ if(shoe[r]<0) shoe[r]=0; } return shoe; }
function shoeSize(shoe){ return RANKS.reduce((a,r)=>a+shoe[r],0); }
function drawRandom(shoe){ const n=shoeSize(shoe); if(n<=0) return null; let t=Math.floor(Math.random()*n)+1; for(const r of RANKS){ t-=shoe[r]; if(t<=0){ shoe[r]--; return r; } } return null; }
function clone(obj){ return JSON.parse(JSON.stringify(obj)); }

function dealerPlay(shoe, up, s17){
  const hand=[up, drawRandom(shoe)];
  while(true){
    const {total, soft}=handTotal(hand);
    if(total>=17){ if(total>21) return {hand,total}; if(total===17 && soft && s17==='H17'){ hand.push(drawRandom(shoe)); continue; } return {hand,total}; }
    hand.push(drawRandom(shoe));
  }
}

function simulateAction(shoe, playerHand, dealerUp, action, das, s17){
  const results={win:0,lose:0,tie:0,total:0};
  const iterations = parseInt(els.samples.value||3000,10);
  for(let i=0;i<iterations;i++){
    const sh=clone(shoe); const p=clone(playerHand);
    let doubled=false;
    if(action==='HIT'){ p.push(drawRandom(sh)); }
    else if(action==='STAND'){ }
    else if(action==='DOUBLE'){ p.push(drawRandom(sh)); doubled=true; }
    else if(action==='SURRENDER'){ results.lose+=1; continue; }
    const dres=dealerPlay(sh, dealerUp, s17);
    const pTotal=handTotal(p).total, dTotal=dres.total;
    let factor = doubled?2:1;
    if(pTotal>21){ results.lose+=factor; }
    else if(dTotal>21 || pTotal>dTotal){ results.win+=factor; }
    else if(pTotal<dTotal){ results.lose+=factor; }
    else{ results.tie+=factor; }
  }
  const ev = (results.win - results.lose)/iterations;
  return ev;
}

function bestAction(){
  if(!dealer || player.length===0) return {};
  const shoe=shoeAfterSeen();
  const actions=['HIT','STAND','DOUBLE','SURRENDER'];
  const evs = actions.map(a=>[a,simulateAction(shoe,player,dealer,a,els.das.value,els.s17.value)]);
  evs.sort((a,b)=>b[1]-a[1]);
  return {res:evs, winner:evs[0]};
}

function renderEV(){
  els.acts.innerHTML=''; els.winner.textContent='—'; els.detail.textContent='';
  if(!dealer || player.length===0) return;
  const {res, winner}=bestAction(); if(!winner) return;
  const map={HIT:'✅ 要牌',STAND:'✅ 停牌',DOUBLE:'✅ 加倍',SPLIT:'✅ 分牌',SURRENDER:'✅ 晚投降'};
  const winnerName=map[winner[0]]||winner[0];
  els.winner.textContent=winnerName;
  els.detail.innerHTML=`<button id="showDetail" class="btn-small" style="margin-top:4px">查看詳細 EV</button>`;
  document.getElementById('showDetail').onclick=()=>{
    els.acts.innerHTML='';
    const values=res.map(r=>r[1]);
    const min=Math.min(...values), max=Math.max(...values);
    res.forEach(([name,val])=>{
      const row=document.createElement('div'); row.className='act '+name; row.style.marginTop='6px';
      const left=document.createElement('div'); left.textContent=name;
      const right=document.createElement('div'); right.className='ev'; right.textContent=(val>=0?'+':'')+val.toFixed(4);
      const bar=document.createElement('div'); bar.className='bar'; bar.style.marginTop='6px';
      const fill=document.createElement('div'); fill.className='fill';
      const pct=(max===min)?50:((val-min)/(max-min)*100); fill.style.width=pct+'%';
      bar.appendChild(fill); row.appendChild(left); row.appendChild(right); els.acts.appendChild(row); els.acts.appendChild(bar);
    });
    els.detail.innerHTML=`最優動作 EV = ${(winner[1]>=0?'+':'')+winner[1].toFixed(4)}<br><button id="hideDetail" class="btn-small" style="margin-top:4px">隱藏詳細 EV</button>`;
    document.getElementById('hideDetail').onclick=()=>{ renderEV(); };
  };
}

function render(){
  buildSeenButtons();
  buildPickers();
  els.playerView.innerHTML=''; player.forEach(r=>els.playerView.appendChild(makeCardEl(r)));
  els.dealerView.innerHTML=''; if(dealer) els.dealerView.appendChild(makeCardEl(dealer));
  const shoe=shoeAfterSeen();
  els.leftCnt.textContent=shoeSize(shoe);
  els.hiCnt.textContent=RANKS.reduce((a,r)=>a+((r==='10'||r==='J'||r==='Q'||r==='K'||r==='A')?shoe[r]:0),0);
  renderEV();
}

els.undo.onclick=()=>{ if(player.length>0){ player.pop(); render(); } };
els.clear.onclick=()=>{ player=[]; render(); };
els.reset.onclick=()=>{ for(const r of RANKS) seen[r]=0; seenHistory=[]; dealer=null; player=[]; render(); };

buildSeenButtons();
buildPickers();
render();
</script>
</body>
</html>
